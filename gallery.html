<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Book Gallery</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 16px;
  }

  h1 {
    margin-top: 0;
    margin-bottom: 8px;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 8px;
  }

  select, input, button {
    padding: 4px 6px;
    font-size: 14px;
  }

  #viewer {
    text-align: center;
    margin-bottom: 8px;
  }

  #mainImage {
    max-width: 100%;
    max-height: 80vh;
    border: 1px solid #aaa;
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
    cursor: zoom-in;
    transition: transform 0.3s ease;
    user-select: none;
  }

  #mainImage.zoomed {
    cursor: zoom-out;
    max-width: none;
    max-height: none;
    transform-origin: center center;
  }

  #mainImage.dragging {
    cursor: grab !important;
  }

  #mainImage.dragging:active {
    cursor: grabbing !important;
  }

  #viewer.zoomed {
    overflow: auto;
    max-height: 80vh;
  }

  /* Navigation buttons */
  .nav-button {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    font-size: 32px;
    width: 60px;
    height: 80px;
    cursor: pointer;
    transition: background 0.2s;
    z-index: 100;
  }

  .nav-button:hover {
    background: rgba(0, 0, 0, 0.7);
  }

  #prevButton {
    left: 0;
  }

  #nextButton {
    right: 0;
  }

  /* Horizontal thumbnail strip */
  #thumbStrip {
    display: flex;
    flex-direction: row;
    gap: 6px;
    overflow-x: auto;
    padding: 4px 0;
    border-top: 1px solid #ccc;
    margin-top: 4px;
    transition: opacity 0.3s;
  }

  body.fullscreen .controls,
  body.fullscreen h1,
  body.fullscreen #thumbStrip {
    opacity: 0;
    pointer-events: none;
  }

  body.fullscreen #mainImage {
    max-height: 100vh;
  }

  .thumb {
    height: 80px;
    flex: 0 0 auto;
    border: 1px solid #ccc;
    cursor: pointer;
  }

  .thumb.selected {
    border: 3px solid #0074d9;
  }
</style>
</head>
<body>

<!-- Main App -->
<div id="app">
  <h1 id="title">Gallery</h1>

  <div class="controls">
    <label>Book:
      <select id="bookSelect"></select>
    </label>

    <label>Page:
      <select id="pageSelect"></select>
    </label>

    <label>Go:
      <input id="pageInput" type="text" size="4" placeholder="123" />
      <button id="pageGoButton">Go</button>
    </label>
  </div>

  <div id="viewer">
    <button id="prevButton" class="nav-button">‹</button>
    <img id="mainImage" />
    <button id="nextButton" class="nav-button">›</button>
  </div>

  <div id="thumbStrip"></div>
</div>

<!-- Your page index from Python -->
<script src="books/index.js"></script>

<script>
  const OFFSET = 10;

  const app          = document.getElementById("app");
  const titleEl      = document.getElementById("title");
  const bookSelect   = document.getElementById("bookSelect");
  const pageSelect   = document.getElementById("pageSelect");
  const pageInput    = document.getElementById("pageInput");
  const pageGoButton = document.getElementById("pageGoButton");
  const mainImage    = document.getElementById("mainImage");
  const thumbStrip   = document.getElementById("thumbStrip");
  const prevButton   = document.getElementById("prevButton");
  const nextButton   = document.getElementById("nextButton");

  let currentBook  = null;
  let pages        = [];
  let currentIndex = 0;
  let thumbEls     = [];
  let isZoomed     = false;
  let zoomLevel    = 1;
  let isDragging   = false;
  let dragStartX   = 0;
  let dragStartY   = 0;
  let scrollStartX = 0;
  let scrollStartY = 0;
  let spacePressed = false;

  /* ------------------ GALLERY INIT ------------------ */

  function init() {
    const books = Object.keys(window.BOOK_DATA).sort();

    books.forEach(book => {
      const opt = document.createElement("option");
      opt.value = book;
      opt.textContent = book;
      bookSelect.appendChild(opt);
    });

    const params = new URLSearchParams(window.location.search);
    const urlBook = params.get("book");
    const initial = (urlBook && books.includes(urlBook)) ? urlBook : books[0];

    bookSelect.value = initial;
    loadBook(initial);

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft")  showPage(currentIndex - 1);
      if (e.key === "ArrowRight") showPage(currentIndex + 1);
      if (e.key === " " && !spacePressed) {
        spacePressed = true;
        if (isZoomed) {
          mainImage.classList.add('dragging');
        }
        e.preventDefault();
      }
    });

    document.addEventListener("keyup", e => {
      if (e.key === " ") {
        spacePressed = false;
        mainImage.classList.remove('dragging');
        isDragging = false;
      }
    });
  }

  function loadBook(book) {
    currentBook  = book;
    pages        = window.BOOK_DATA[book];
    currentIndex = 0;

    titleEl.textContent = "Gallery – " + book;

    buildPageDropdown();
    buildThumbStrip();

    if (pages.length > 0) showPage(0);
  }

  /* ------------------ PAGE CONTROLS ------------------ */

  function buildPageDropdown() {
    pageSelect.innerHTML = "";
    pages.forEach((file, idx) => {
      const opt = document.createElement("option");
      const printed = (idx + 1 - OFFSET);
      const printedLabel = printed.toString().padStart(3, "0");
      opt.value = idx;
      opt.textContent = printedLabel;
      pageSelect.appendChild(opt);
    });
    pageSelect.value = "0";
  }

  function buildThumbStrip() {
    thumbStrip.innerHTML = "";
    thumbEls = [];

    pages.forEach((file, idx) => {
      const img = document.createElement("img");
      img.src = `books/${currentBook}/thumbs/${file}`;
      img.className = "thumb";
      img.onclick = () => showPage(idx);
      thumbStrip.appendChild(img);
      thumbEls.push(img);
    });
  }

  function showPage(idx) {
    if (idx < 0 || idx >= pages.length) return;

    currentIndex = idx;
    const file = pages[idx];
    mainImage.src = `books/${currentBook}/${file}`;
    pageSelect.value = idx;

    thumbEls.forEach((el, i) =>
      el.classList.toggle("selected", i === idx)
    );

    thumbEls[idx].scrollIntoView({ behavior: "smooth", inline: "center" });
    
    // Reset zoom when changing pages
    resetZoom();
  }

  /* ------------------ JUMP TO PAGE ------------------ */

  function goToPageFromInput() {
    const raw = pageInput.value.trim();
    if (!raw) return;

    const printed = parseInt(raw, 10);
    if (isNaN(printed)) return;

    let internal = printed + OFFSET;

    if (internal < 1) internal = 1;
    if (internal > pages.length) internal = pages.length;

    const idx = internal - 1;
    showPage(idx);
  }

  pageInput.onkeydown = e => { if (e.key === "Enter") goToPageFromInput(); };
  pageGoButton.onclick = goToPageFromInput;
  pageSelect.onchange = () => showPage(parseInt(pageSelect.value));
  bookSelect.onchange = () => loadBook(bookSelect.value);

  // Navigation buttons
  prevButton.onclick = () => showPage(currentIndex - 1);
  nextButton.onclick = () => showPage(currentIndex + 1);

  // Zoom functions
  function resetZoom() {
    isZoomed = false;
    zoomLevel = 1;
    mainImage.classList.remove('zoomed');
    mainImage.style.transform = 'scale(1)';
    document.getElementById('viewer').classList.remove('zoomed');
  }

  function toggleZoom(e) {
    if (!isZoomed) {
      isZoomed = true;
      zoomLevel = 2;
      mainImage.classList.add('zoomed');
      mainImage.style.transform = 'scale(2)';
      document.getElementById('viewer').classList.add('zoomed');
    } else {
      resetZoom();
    }
    e.stopPropagation();
  }

  // Double-click to zoom
  mainImage.addEventListener('dblclick', toggleZoom);

  // Mouse wheel to zoom
  mainImage.addEventListener('wheel', (e) => {
    e.preventDefault();
    
    if (e.deltaY < 0) {
      // Zoom in
      zoomLevel = Math.min(zoomLevel + 0.2, 4);
    } else {
      // Zoom out
      zoomLevel = Math.max(zoomLevel - 0.2, 1);
    }
    
    if (zoomLevel > 1) {
      isZoomed = true;
      mainImage.classList.add('zoomed');
      mainImage.style.transform = `scale(${zoomLevel})`;
      document.getElementById('viewer').classList.add('zoomed');
    } else {
      resetZoom();
    }
    
    e.stopPropagation();
  });

  // Drag to pan when spacebar is held
  mainImage.addEventListener('mousedown', (e) => {
    if (spacePressed && isZoomed) {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      scrollStartX = document.getElementById('viewer').scrollLeft;
      scrollStartY = document.getElementById('viewer').scrollTop;
      e.preventDefault();
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging && spacePressed && isZoomed) {
      const deltaX = dragStartX - e.clientX;
      const deltaY = dragStartY - e.clientY;
      document.getElementById('viewer').scrollLeft = scrollStartX + deltaX;
      document.getElementById('viewer').scrollTop = scrollStartY + deltaY;
    }
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  // Initialize immediately
  init();

  // Enter fullscreen mode after 1 second
  setTimeout(() => {
    document.body.classList.add('fullscreen');
  }, 1000);

  // Click anywhere to toggle fullscreen mode (except on controls)
  document.addEventListener('click', (e) => {
    // Don't toggle if clicking on controls
    if (e.target.closest('.controls') || e.target.closest('#thumbStrip')) {
      return;
    }
    
    // Don't toggle if clicking nav buttons
    if (e.target.closest('.nav-button')) {
      return;
    }
    
    // Don't toggle if image is zoomed
    if (isZoomed) {
      return;
    }
    
    // Check if clicking in left or right navigation zones
    const clickX = e.clientX;
    const windowWidth = window.innerWidth;
    const navZoneWidth = windowWidth * 0.25; // 25% from each side
    
    if (clickX < navZoneWidth) {
      // Left zone - previous page
      showPage(currentIndex - 1);
      return;
    } else if (clickX > windowWidth - navZoneWidth) {
      // Right zone - next page
      showPage(currentIndex + 1);
      return;
    }
    
    // Middle zone - toggle fullscreen
    document.body.classList.toggle('fullscreen');
  });

</script>

</body>
</html>